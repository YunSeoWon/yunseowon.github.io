---
layout: post
title: NHN Basecamp 웹 서버 스케일아웃 교육
author: YunSeoWon
date: '2020-02-17 09:30:00'
category: javascript
summary: NHN Basecamp 웹 서버 스케일아웃 교육
thumbnail: scaleout.png
---





# 웹 서버 스케일 아웃

NHN Basecamp에서 배웠던 웹 서버 스케일 아웃 교육 내용을 정리하려고 한다.



## 처음에는..

개발 초기에는 웹서버, DB서버를 한 대로 운영하였다. 이 때는 개발은 쉬울지 몰라도 원만한 운영을 하기 힘들다는 단점이 있다. 아무래도 동시 접속하는 사용자가 많아진다면 서버 성능이 아무리 좋아도 한 대로는 부족할 것이다. 그래서 성능을 올리기 위해서 웹 서버를 두 대 이상 운영하게 될 것이다. 하지만 서버의 개수를 늘릴 때에는 몇 가지 고려 사항이 있다.



## 스케일아웃

스케일아웃을 하는 방법은 여러가지가 있는데 각각을 살펴보자.



### 두 대의 서버: 웹 서버 1, 디비 서버 1

![](/assets/img/posts/scaleout/1-1.png){:class="img-fluid"}



웹 서버 하나는 하나의 DB서버에 접근하게 된다. 

이 모델의 장점은 웹 서버의 트래픽과 DB를 접근할 때의 트래픽은 두 개의 서버로 나누게 되어 성능 면에서 이득을 볼 수 있다.

하지만, 웹 서버와 DB 서버 둘 중 하나만 죽어도 제 기능을 못한다는 단점이 있다. (SPOF)



### 세 대의 서버: 웹 서버 2, 디비 서버 1

![](/assets/img/posts/scaleout/2-1.png){:class="img-fluid"}



다음 모델은 두 개의 웹 서버가 하나의 DB에 접근하게 된다. 여기서는 하나의 웹 서버가 죽어도 다른 웹 서버가 살아있다면 서비스를 할 수 있다는 장점이 있고, 두 대의 웹 서버가 트래픽을 나누기 때문에 성능면에서 이득을 볼 수 있다.

하지만, 두 개의 웹서버는 IP가 달라서 두 서버에 트래픽을 분배하는 로드밸런서가 필요하다.





## 스케일 아웃 시 고려해야 할 사항

웹서버를 두 대 이상으로 스케일아웃하면 다음과 같은 구조가 된다.

![](/assets/img/posts/scaleout/lb.png){:class="img-fluid"}

이 때, 고려해야 할 몇 가지 사항을 정리해보겠다.

 

### 헬스체크

먼저 로드밸런서는 클라이언트에게 두 대 이상의 웹 서버 중 한 서버에 연결해주는 역할을 하고 있다. 하지만, 한 서버가 죽으면 로드밸런서는 클라언트에게 죽은 서버로 연결해주면 안된다. 그래서 웹 서버가 적절히 살아있는지 주기적으로 체크를 해줘야 한다.

![](/assets/img/posts/scaleout/dead.png){:class="img-fluid"}

헬스체크는 두 가지 방법이 있다.

**1. L4 헬스체크**

여기서 말하는 L은 OSI 7계층의 layer를 의미한다. 즉, L4 헬스체크는 ip와 port번호를 이용하여 이 서버가 살아있는지 죽어있는지 체크한다. 로드밸런서는 L4 헬스체크에서 죽었다고 판단하는 웹 서버에는 트래픽 분배 대상에서 제거하여 클라이언트에게 죽은 서버로 연결이 되지 않게 할 수 있다.

**2. L7 헬스체크**

L7은 appliation layer로, http(s)를 쓰고 있는 서버의 경우, url까지 설정하여 헬스체크를 할 수 있다. 보통 curl와 같이 서버에 특정 url로 요청을 하여 200이 나오는지 판단하고, 200이 나오지 않는 경우, 이 서버는 문제가 있다고 판단하여 로드밸런서의 트래픽 분배 대상에서 제거시킬 수 있다.



### 세션 공유

SpringBoot를 이용할 때, 보통 세션은 Spring 내장 세션 스토리지를 이용한다. 이 것은 서버 한 대로 운영할 때는 아무런 문제가 없는데, 두 대 이상이 되면 문제가 발생하게 된다. 

먼저 사용자는 웹 서비스를 이용하기 위해서 웹 애플리케이션에 로그인을 시도한다. 로그인에 성공하고 1번 서버에 로그인 정보가 세션에 저장된다. 그리고 다른 서비스를 이용할 때, 로드밸런서는 클라이언트에게 2번 서버로 연결을 시켜주었다. 이 때, 2번 서버는 로그인한 회원 정보가 세션에 저장되지 않아서 '로그인을 하지 않아서 서비스를 이용할 수 없습니다.'라는 메세지와 함께 로그인 화면으로 이동하게 된다. 이는 서비스 할 때 문제가 된다.

이를 해결하기 위해서는 서버 사이에 세션을 공유해야 한다. 

![](/assets/img/posts/scaleout/session.png){:class="img-fluid"}

서버들 사이에 세션을 공유하기 위해 Redis가 자주 사용된다.



### 스토리지 공유

메일 서비스의 경우, 사용자가 업로드한 첨부파일을 서버의 스토리지에 보관하여 관리한다. 하지만 이 첨부파일은 서버가 두 대 이상으로 스케일아웃하게 되면 파일 자료들은 서버 사이에 공유가 되어야 한다. 

그래서 이런 공유 스토리지 공간을 정해야 하는데, 종류로는 NFS(Network File System)이 있고, NHN TOAST의 ObjectStorage 등이 있다.











